<!--pages/index/index.wxml-->
<view class="container {{isDark ? 'dark' : ''}}">
  <!-- åœ°å›¾å®¹å™¨ -->
  <view class="map-container">
    <map
      id="mainMap"
      class="map"
      latitude="{{latitude}}"
      longitude="{{longitude}}"
      scale="14"
      markers="{{markers}}"
      show-location="{{false}}"
      bindregionchange="onMapRegionChange"
      bindtap="onMapTap"
    >
    </map>

    <!-- åœ°å›¾ä¸­å¿ƒé”šç‚¹ï¼ˆå›ºå®šåœ¨å±å¹•ä¸­å¿ƒï¼‰ -->
    <view class="map-anchor">
      <view class="anchor-pin">
        <view class="anchor-dot"></view>
        <view class="anchor-stick"></view>
      </view>
    </view>

    <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
    <view class="map-controls">
      <view class="control-btn" bindtap="relocate">
        <text class="icon">âŠ™</text>
      </view>
    </view>
  </view>

  <!-- ä¸»é¡µå†…å®¹ -->
  <view wx:if="{{currentState === 'home'}}" class="draggable-panel {{isDragging ? '' : 'panel-transition'}}" style="height: {{panelHeight}}vh;">
    <view class="panel-content">
      <!-- æ‹–åŠ¨æ¡ -->
      <view 
        class="drag-handle" 
        bindtouchstart="onDragStart"
        catchtouchmove="onDragMove"
        bindtouchend="onDragEnd"
        bindtouchcancel="onDragEnd"
      >
        <view class="drag-bar"></view>
      </view>

      <view class="panel-body">
        <!-- ä½ç½®ä¿¡æ¯ -->
        <view class="location-section">
          <view class="location-item">
            <view class="location-dot-start"></view>
            <view class="location-info">
              <text class="location-label">ä¸Šè½¦åœ°ç‚¹</text>
              <text class="location-text">{{startLocation}}</text>
            </view>
          </view>

          <!-- ç›®çš„åœ°è¾“å…¥ -->
          <view class="destination-input-wrapper">
            <view class="destination-input">
              <text class="input-icon">ğŸ“</text>
              <input
                class="input-field"
                placeholder="ä½ æƒ³å»å“ªå„¿ï¼Ÿ"
                value="{{destination}}"
                bindinput="onDestinationInput"
              />
            </view>
          </view>

          <!-- å¿«é€Ÿé€‰é¡¹ -->
          <view class="quick-options">
            <view class="quick-btn">
              <text class="quick-icon">ğŸ•</text>
              <text class="quick-text">é¢„çº¦</text>
            </view>
            <view class="quick-btn">
              <text class="quick-icon">ğŸ‘¥</text>
              <text class="quick-text">å¸®äººå«è½¦</text>
            </view>
            <view class="quick-btn">
              <text class="quick-icon">âœˆï¸</text>
              <text class="quick-text">æ¥é€æœº</text>
            </view>
          </view>
        </view>

        <!-- ä¿ƒé”€æ¡ -->
        <view class="promo-bar">
          <view class="promo-content">
            <text class="promo-title">æ–°ç”¨æˆ·ä¸“å±</text>
            <text class="promo-subtitle">é¦–å•äº«å—éœ“è™¹ä¼˜æƒ </text>
          </view>
          <text class="promo-arrow">â†’</text>
        </view>

        <!-- æœåŠ¡ç½‘æ ¼ -->
        <view class="services-section">
          <text class="section-title">å‡ºè¡ŒæœåŠ¡</text>
          <view class="services-grid">
            <view
              wx:for="{{mainServices}}"
              wx:key="id"
              class="service-item"
              data-id="{{item.id}}"
              bindtap="onServiceSelect"
            >
              <view class="service-icon">
                <text class="service-emoji">{{item.icon}}</text>
              </view>
              <text class="service-name">{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- ç¦åˆ©æç¤º -->
        <view class="welfare-tip">
          <text class="welfare-title">æ–°ç”¨æˆ·ä¸“å±ç¦åˆ©</text>
          <text class="welfare-subtitle">é¦–å•ä¼˜æƒ  â€¢ å€’è®¡æ—¶ 01:39:05</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åœ°å€è¾“å…¥é¡µ -->
  <view wx:if="{{currentState === 'address'}}" class="draggable-panel {{isDragging ? '' : 'panel-transition'}}" style="height: 75vh;">
    <view class="panel-content">
      <view 
        class="drag-handle"
        bindtouchstart="onDragStart"
        catchtouchmove="onDragMove"
        bindtouchend="onDragEnd"
        bindtouchcancel="onDragEnd"
      >
        <view class="drag-bar"></view>
      </view>

      <view class="panel-body">
        <!-- è¿”å›æŒ‰é’® -->
        <view class="back-btn" bindtap="backToHome">
          <text class="back-icon">â†</text>
          <text class="back-text">è¿”å›</text>
        </view>

        <!-- åœ°å€è¾“å…¥ -->
        <view class="address-input-section">
          <text class="section-title-small">é€‰æ‹©å‡ºè¡Œåœ°ç‚¹</text>

          <!-- å‡ºå‘åœ° -->
          <view class="address-input-item">
            <text class="address-label">ä¸Šè½¦åœ°å€</text>
            <view class="address-input-box start-address-readonly">
              <text class="address-icon">ğŸ“</text>
              <input
                class="address-input-field"
                placeholder="å½“å‰ä½ç½®"
                value="{{startAddress}}"
                disabled="{{true}}"
                bindinput="onStartAddressInput"
              />
              <text class="readonly-hint">ï¼ˆå½“å‰ä½ç½®ï¼‰</text>
            </view>
          </view>

          <!-- ç›®çš„åœ° -->
          <view class="address-input-item destination-item">
            <text class="address-label">ç›®çš„åœ°åœ°å€</text>
            <view class="address-input-box destination-box">
              <text class="address-icon accent-icon">ğŸ“</text>
              <input
                class="address-input-field"
                placeholder="è¾“å…¥ç›®çš„åœ°"
                value="{{endAddress}}"
                bindinput="onEndAddressInput"
              />
            </view>
            
            <!-- å…³é”®è¯æç¤ºåˆ—è¡¨ -->
            <view class="suggestions-list" wx:if="{{showSuggestions && suggestions.length > 0}}">
              <scroll-view scroll-y class="suggestions-scroll">
                <view 
                  class="suggestion-item" 
                  wx:for="{{suggestions}}" 
                  wx:key="id"
                  data-index="{{index}}"
                  bindtap="selectSuggestion"
                >
                  <view class="suggestion-title">{{item.title}}</view>
                  <view class="suggestion-address">{{item.address}}</view>
                </view>
              </scroll-view>
            </view>
          </view>
        </view>

        <!-- è®¡ç®—ç»“æœ -->
        <view wx:if="{{distance !== null}}" class="calculation-result">
          <view class="result-grid">
            <view class="result-item">
              <text class="result-value primary-value">{{price}}</text>
              <text class="result-label">é¢„ä¼°ä»·æ ¼ Â¥</text>
            </view>
            <view class="result-item bordered">
              <text class="result-value accent-value">{{time}}</text>
              <text class="result-label">é¢„ä¼°æ—¶é—´ åˆ†</text>
            </view>
            <view class="result-item">
              <text class="result-value">{{distance}}</text>
              <text class="result-label">è·ç¦» km</text>
            </view>
          </view>

          <view class="result-divider"></view>

          <view class="service-info-row">
            <text class="service-name-text">{{serviceName}}</text>
            <view class="service-badge">
              <text class="service-badge-text">å‡ºè¡ŒæœåŠ¡</text>
            </view>
          </view>
        </view>

        <!-- ç¡®è®¤æŒ‰é’® -->
        <view class="confirm-btn {{distance === null ? 'disabled' : ''}}" bindtap="confirmAddress">
          <text class="confirm-btn-text">ç¡®è®¤è¡Œç¨‹ä¿¡æ¯</text>
        </view>

        <!-- æç¤º -->
        <view wx:if="{{distance === null}}" class="tip-text">
          <text>è¯·è¾“å…¥ä¸Šè½¦åœ°å€å’Œç›®çš„åœ°æ¥è·å–ä»·æ ¼ä¼°ç®—</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è®¢å•é¡µ -->
  <view wx:if="{{currentState === 'order' && orderData}}" class="draggable-panel {{isDragging ? '' : 'panel-transition'}}" style="height: 80vh;">
    <view class="panel-content">
      <view 
        class="drag-handle"
        bindtouchstart="onDragStart"
        catchtouchmove="onDragMove"
        bindtouchend="onDragEnd"
        bindtouchcancel="onDragEnd"
      >
        <view class="drag-bar"></view>
      </view>

      <view class="panel-body">
        <!-- è¿”å›æŒ‰é’® -->
        <view class="back-btn" bindtap="backToAddress">
          <text class="back-icon">â†</text>
          <text class="back-text">ä¿®æ”¹è¡Œç¨‹</text>
        </view>

        <!-- å‡ºå‘åœ°å’Œç›®çš„åœ° -->
        <view class="route-display">
          <view class="route-point">
            <view class="route-dot start-dot"></view>
            <view class="route-info">
              <text class="route-label">ä¸Šè½¦åœ°ç‚¹</text>
              <text class="route-text">{{orderData.startAddress}}</text>
            </view>
          </view>

          <view class="route-line"></view>

          <view class="route-point">
            <view class="route-dot end-dot"></view>
            <view class="route-info">
              <text class="route-label">ç›®çš„åœ°</text>
              <text class="route-text">{{orderData.endAddress}}</text>
            </view>
          </view>
        </view>

        <!-- ä»·æ ¼æ—¶é—´è·ç¦»ä¿¡æ¯ -->
        <view class="order-info-grid">
          <view class="order-info-item">
            <text class="order-info-value primary-value">Â¥{{orderData.price}}</text>
            <text class="order-info-label">é¢„ä¼°ä»·æ ¼</text>
          </view>
          <view class="order-info-item bordered">
            <text class="order-info-value accent-value">{{orderData.time}}</text>
            <text class="order-info-label">é¢„ä¼°æ—¶é—´</text>
          </view>
          <view class="order-info-item">
            <text class="order-info-value">{{orderData.distance}}</text>
            <text class="order-info-label">è·ç¦» km</text>
          </view>
        </view>

        <!-- é€‰ä¸­çš„æœåŠ¡ç±»å‹ -->
        <view class="selected-service">
          <view class="selected-service-icon">
            <text>ğŸš—</text>
          </view>
          <view class="selected-service-info">
            <text class="selected-service-name">{{orderData.serviceName}}</text>
            <text class="selected-service-desc">å¿«é€Ÿä¸“ä¸šå‡ºè¡Œ</text>
          </view>
          <view class="change-service-btn" bindtap="backToAddress">
            <text class="change-service-text">æ›´æ¢</text>
          </view>
        </view>

        <!-- ä¹˜å®¢æ•°é€‰æ‹© -->
        <view class="passengers-selector">
          <view class="passengers-info">
            <text class="passengers-title">ä¹˜å®¢æ•°</text>
            <text class="passengers-subtitle">éœ€è¦ä¹˜è½¦çš„ä¹˜å®¢æ•°é‡</text>
          </view>
          <view class="passengers-controls">
            <view class="passenger-btn" bindtap="decreasePassengers">
              <text>âˆ’</text>
            </view>
            <text class="passenger-count">{{passengers}}</text>
            <view class="passenger-btn" bindtap="increasePassengers">
              <text>+</text>
            </view>
          </view>
        </view>

        <!-- ç«‹å³ä¸‹å•æŒ‰é’® -->
        <view class="place-order-btn" bindtap="placeOrder">
          <text class="place-order-text">ç«‹å³ä¸‹å•</text>
        </view>

        <!-- å…¶ä»–é€‰é¡¹ -->
        <view class="order-actions">
          <view class="order-action-btn" bindtap="shareTrip">
            <text class="action-icon">ğŸ”—</text>
            <text class="action-text">åˆ†äº«è¡Œç¨‹</text>
          </view>
          <view class="order-action-btn" bindtap="addStopover">
            <text class="action-icon">â•</text>
            <text class="action-text">æ·»åŠ åœé ç‚¹</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

